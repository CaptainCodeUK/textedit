@page "/"
@using Microsoft.AspNetCore.Components
@using TextEdit.UI.App
@using TextEdit.UI.Components.Preview
@using TextEdit.UI.Components.Dialogs
@using TextEdit.UI.Components
@using TextEdit.UI.Services
@using TextEdit.Core.Preferences
@implements IDisposable
@using Microsoft.JSInterop
@inject AppState AppState
@inject DialogService DialogService
@inject ElectronIpcListener IpcListener
@inject TextEdit.UI.Services.ThemeManager ThemeManager
@inject IJSRuntime JS

<LayoutView Layout="typeof(TextEdit.UI.Shared.MainLayout)">
    <div class="app-container" style="height:100%;min-height:0;display:flex;flex-direction:column;">

@if (AppState.EditorState.ShowPreview)
        {
            <div style="display:flex;height:100%;min-height:0;flex:1 1 auto;gap:1px;background:var(--border);">
                <div style="flex:1;min-width:0;display:flex;flex-direction:column;">
                    <TextEditor />
                </div>
                <div style="flex:1;min-width:0;display:flex;flex-direction:column;overflow:auto;">
                    <PreviewPanel />
                </div>
            </div>
        }
        else
        {
            <TextEditor />
        }
    </div>
</LayoutView>

<!-- Global Dialog Components -->
<ErrorDialog 
    IsVisible="@DialogService.ShowError" 
    Title="@DialogService.ErrorTitle" 
    Message="@DialogService.ErrorMessage"
    OnClose="@(() => DialogService.HideErrorDialog())" />

<ConfirmDialog 
    IsVisible="@DialogService.ShowConfirm" 
    Title="@DialogService.ConfirmTitle" 
    Message="@DialogService.ConfirmMessage"
    OnResult="@DialogService.HandleConfirmResult" />

<AboutDialog 
    IsVisible="@DialogService.ShowAbout"
    OnClose="@(() => DialogService.HideAboutDialog())" />

<OptionsDialog 
    IsVisible="@DialogService.ShowOptions"
    OnClose="@(() => DialogService.HideOptionsDialog())" />

@code {
    protected override void OnInitialized()
    {
        AppState.Changed += OnAppStateChanged;
        DialogService.Changed += OnDialogServiceChanged;
    }

    private void OnAppStateChanged()
    {
        InvokeAsync(async () =>
        {
            await ApplyThemeToDomAsync();
            StateHasChanged();
        });
    }

    private void OnDialogServiceChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    // Run restore only once on the client after the circuit is established to avoid
    // duplicate execution during prerendering.
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // Initialize IPC listeners for Electron messages
            await IpcListener.InitializeAsync();

            // Load user preferences (including theme) BEFORE applying theme
            await AppState.LoadPreferencesAsync();

            // Ensure theme is applied to DOM on first render
            await ApplyThemeToDomAsync();

            // OS theme change detection deferred – no JS watcher registration

            // Restore previous session (unsaved documents) on startup
            await AppState.RestoreSessionAsync();
        }
        catch (Exception)
        {
            // If restore fails, ensure we at least have one document
            if (AppState.ActiveDocument == null)
            {
                AppState.CreateNew();
            }
        }
    }

    public void Dispose()
    {
        AppState.Changed -= OnAppStateChanged;
        DialogService.Changed -= OnDialogServiceChanged;
        // No OS theme watcher to unhook (deferred)
    }

    private int _lastAppliedThemeVersion = -1;
    private async Task ApplyThemeToDomAsync()
    {
        // Use ThemeManager.CurrentTheme and version to detect changes
        var theme = (ThemeManager?.CurrentTheme ?? "Light").ToLowerInvariant();
        var version = ThemeManager?.ThemeVersion ?? 0;

        if (_lastAppliedThemeVersion == version)
        {
            return;
        }
        
        _lastAppliedThemeVersion = version;
        try
        {
            await JS.InvokeVoidAsync("theme.set", theme);
            // Keep native menus in sync with the resolved theme
            await JS.InvokeVoidAsync("electronIpc.send", "theme:setThemeSource", theme);
        }
        catch (Exception)
        {
            // Intentionally suppress non-theme debug output; failures are non-fatal
        }
    }

    // OS theme change detection deferred – no JSInvokable handler
}
