@page "/"
@using Microsoft.AspNetCore.Components
@using TextEdit.UI.App
@using TextEdit.UI.Components.Preview
@using TextEdit.UI.Components.Dialogs
@using TextEdit.UI.Components
@using TextEdit.UI.Services
@using TextEdit.Core.Preferences
@implements IDisposable
@using Microsoft.JSInterop
@inject AppState AppState
@inject DialogService DialogService
@inject ElectronIpcListener IpcListener
@inject TextEdit.UI.Services.ThemeManager ThemeManager
@inject TextEdit.Infrastructure.Updates.AutoUpdateService AutoUpdateService
@inject IJSRuntime JS

<LayoutView Layout="typeof(TextEdit.UI.Shared.MainLayout)">
    <div class="app-container" style="height:100%;min-height:0;display:flex;flex-direction:column;">

@if (AppState.EditorState.ShowPreview)
        {
            <div style="display:flex;height:100%;min-height:0;flex:1 1 auto;gap:1px;background:var(--border);">
                <div style="flex:1;min-width:0;display:flex;flex-direction:column;">
                    <TextEditor @key="@(AppState.EditorState.ShowPreview ? "editor-preview" : "editor")" />
                </div>
                <div style="flex:1;min-width:0;display:flex;flex-direction:column;overflow:auto;">
                    <PreviewPanel />
                </div>
            </div>
        }
        else
        {
            <TextEditor @key="@(AppState.EditorState.ShowPreview ? "editor-preview" : "editor")" />
        }
    </div>
</LayoutView>

<!-- Global Dialog Components -->
<ErrorDialog 
    IsVisible="@DialogService.ShowError" 
    Title="@DialogService.ErrorTitle" 
    Message="@DialogService.ErrorMessage"
    OnClose="@(() => DialogService.HideErrorDialog())" />

<ConfirmDialog 
    IsVisible="@DialogService.ShowConfirm" 
    Title="@DialogService.ConfirmTitle" 
    Message="@DialogService.ConfirmMessage"
    OnResult="@DialogService.HandleConfirmResult" />

<AboutDialog 
    IsVisible="@DialogService.ShowAbout"
    OnClose="@(() => DialogService.HideAboutDialog())" />

<OptionsDialog 
    IsVisible="@DialogService.ShowOptions"
    OnClose="@(() => DialogService.HideOptionsDialog())" />

<UpdateNotificationDialog
    IsVisible="@DialogService.ShowUpdateNotification"
    UpdateMetadata="@DialogService.UpdateMetadata"
    OnInstall="@HandleUpdateInstall"
    OnRemindLater="@HandleUpdateRemindLater" />

@code {
    protected override void OnInitialized()
    {
        AppState.Changed += OnAppStateChanged;
        DialogService.Changed += OnDialogServiceChanged;
        AutoUpdateService.StatusChanged += OnUpdateStatusChanged;
    }

    private void OnAppStateChanged()
    {
        InvokeAsync(async () =>
        {
            await ApplyThemeToDomAsync();
            StateHasChanged();
        });
    }

    private void OnDialogServiceChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Handle update status changes - show notification when Ready (US6)
    /// </summary>
    private void OnUpdateStatusChanged(TextEdit.Core.Updates.UpdateStatus status, TextEdit.Core.Updates.UpdateMetadata? metadata)
    {
        InvokeAsync(() =>
        {
            // Show the modal update dialog when update is Available or Ready.
            // Earlier we hid the dialog for Available; display it again but ensure it renders as a modal overlay.
            if ((status == TextEdit.Core.Updates.UpdateStatus.Ready || status == TextEdit.Core.Updates.UpdateStatus.Available) && metadata != null)
            {
                // Only show update notification dialog if check-on-startup is enabled,
                // or the check was initiated manually via the Options dialog.
                if (AppState.Preferences.Updates.CheckOnStartup || AutoUpdateService.LastCheckWasManual)
                {
                    DialogService.ShowUpdateNotificationDialog(metadata);
                    // Clear the manual flag so subsequent periodic checks don't use it
                    try { AutoUpdateService.ClearLastCheckWasManual(); } catch { }
                }
                else
                {
                    // Update is available, but user has disabled automatic checks on startup; do not show.
                    _ = Task.CompletedTask;
                }
            }
            else if (status == TextEdit.Core.Updates.UpdateStatus.Error)
            {
                // Log error but don't show to user (per FR-033)
                // Errors are logged in AutoUpdateService
            }
        });
    }

    // Run restore only once on the client after the circuit is established to avoid
    // duplicate execution during prerendering.
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // Initialize IPC listeners for Electron messages
            await IpcListener.InitializeAsync();

            // Load user preferences (including theme) BEFORE applying theme
            await AppState.LoadPreferencesAsync();

            // Ensure theme is applied to DOM on first render
            await ApplyThemeToDomAsync();

            // OS theme change detection deferred – no JS watcher registration

            // Restore previous session (unsaved documents) on startup
            await AppState.RestoreSessionAsync();
        }
        catch (Exception)
        {
            // If restore fails, ensure we at least have one document
            if (AppState.ActiveDocument == null)
            {
                AppState.CreateNew();
            }
        }
    }

    public void Dispose()
    {
        AppState.Changed -= OnAppStateChanged;
        DialogService.Changed -= OnDialogServiceChanged;
        AutoUpdateService.StatusChanged -= OnUpdateStatusChanged;
        // No OS theme watcher to unhook (deferred)
    }

    /// <summary>
    /// Handle install button click - trigger quit and install (US6)
    /// </summary>
    private void HandleUpdateInstall()
    {
        try
        {
            DialogService.HideUpdateNotificationDialog();
            AutoUpdateService.QuitAndInstall();
        }
        catch (Exception ex)
        {
            DialogService.ShowErrorDialog("Update Error", $"Failed to install update: {ex.Message}");
        }
    }

    /// <summary>
    /// Handle remind later button click - dismiss dialog (US6)
    /// </summary>
    private void HandleUpdateRemindLater()
    {
        DialogService.HideUpdateNotificationDialog();
    }

    private int _lastAppliedThemeVersion = -1;
    private async Task ApplyThemeToDomAsync()
    {
        // Use ThemeManager.CurrentTheme and version to detect changes
        var theme = (ThemeManager?.CurrentTheme ?? "Light").ToLowerInvariant();
        var version = ThemeManager?.ThemeVersion ?? 0;

        if (_lastAppliedThemeVersion == version)
        {
            return;
        }
        
        _lastAppliedThemeVersion = version;
        try
        {
            await JS.InvokeVoidAsync("theme.set", theme);
            // Keep native menus in sync with the resolved theme
            await JS.InvokeVoidAsync("electronIpc.send", "theme:setThemeSource", theme);
        }
        catch (Exception)
        {
            // Intentionally suppress non-theme debug output; failures are non-fatal
        }
    }

    // OS theme change detection deferred – no JSInvokable handler
}
