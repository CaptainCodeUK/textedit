@page "/"
@using Microsoft.AspNetCore.Components
@using TextEdit.UI.App
@using TextEdit.UI.Components.Preview
@using TextEdit.UI.Components.Dialogs
@implements IDisposable
@inject AppState AppState
@inject DialogService DialogService

<LayoutView Layout="typeof(TextEdit.UI.Shared.MainLayout)">
    <div class="app-container" style="height:100%;min-height:0;display:flex;flex-direction:column;">

@if (AppState.EditorState.ShowPreview)
        {
            <div style="display:flex;height:100%;min-height:0;flex:1 1 auto;gap:1px;background:#d1d5db;">
                <div style="flex:1;min-width:0;display:flex;flex-direction:column;">
                    <TextEditor />
                </div>
                <div style="flex:1;min-width:0;display:flex;flex-direction:column;overflow:auto;">
                    <PreviewPanel />
                </div>
            </div>
        }
        else
        {
            <TextEditor />
        }
    </div>
</LayoutView>

<!-- Global Dialog Components -->
<ErrorDialog 
    IsVisible="@DialogService.ShowError" 
    Title="@DialogService.ErrorTitle" 
    Message="@DialogService.ErrorMessage"
    OnClose="@(() => DialogService.HideErrorDialog())" />

<ConfirmDialog 
    IsVisible="@DialogService.ShowConfirm" 
    Title="@DialogService.ConfirmTitle" 
    Message="@DialogService.ConfirmMessage"
    OnResult="@DialogService.HandleConfirmResult" />

@code {
    protected override void OnInitialized()
    {
        AppState.Changed += OnAppStateChanged;
        DialogService.Changed += OnDialogServiceChanged;
    }

    private void OnAppStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnDialogServiceChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    // Run restore only once on the client after the circuit is established to avoid
    // duplicate execution during prerendering.
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // Restore previous session (unsaved documents) on startup
            await AppState.RestoreSessionAsync();
        }
        catch (Exception ex)
        {
            // If restore fails, ensure we at least have one document
            Console.WriteLine($"[App] Failed to restore session: {ex.Message}");
            Console.WriteLine($"[App] Stack trace: {ex.StackTrace}");
            if (AppState.ActiveDocument == null)
            {
                AppState.CreateNew();
            }
        }
    }

    public void Dispose()
    {
        AppState.Changed -= OnAppStateChanged;
        DialogService.Changed -= OnDialogServiceChanged;
    }
}
