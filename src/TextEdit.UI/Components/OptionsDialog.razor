@using TextEdit.Core.Preferences
@using TextEdit.UI.App
@using TextEdit.Infrastructure.Ipc
@inject AppState AppState
@inject IpcBridge IpcBridge

@if (IsVisible)
{
    <div class="dialog-overlay" @onclick="OnClose" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div class="dialog-content" @onclick:stopPropagation="true" style="max-width: 520px; width: 100%; background: var(--bg); color: var(--fg); border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.15), 0 10px 10px -5px rgba(0,0,0,0.1); overflow: hidden;">
            <div style="background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--fg);">Options</h2>
                <button @onclick="OnClose"
                        style="border: none; background: transparent; font-size: 20px; color: var(--muted); cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                    Ã—
                </button>
            </div>
            <div style="padding: 24px;">
                <section style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Theme</h3>
                    <div style="display:flex; gap:16px; align-items:center;">
                        <label style="display:flex; gap:6px; align-items:center; cursor:pointer; color: var(--fg);" @onclick="() => SetTheme(ThemeMode.Light)">
                            <input type="radio" name="theme" value="Light" checked="@(AppState.Preferences.Theme == ThemeMode.Light)" />
                            <span>Light</span>
                        </label>
                        <label style="display:flex; gap:6px; align-items:center; cursor:pointer; color: var(--fg);" @onclick="() => SetTheme(ThemeMode.Dark)">
                            <input type="radio" name="theme" value="Dark" checked="@(AppState.Preferences.Theme == ThemeMode.Dark)" />
                            <span>Dark</span>
                        </label>
                        <label style="display:flex; gap:6px; align-items:center; color: var(--muted); cursor:not-allowed;">
                            <input type="radio" name="theme" value="System" disabled checked="@(AppState.Preferences.Theme == ThemeMode.System)" />
                            <span>System (disabled)</span>
                        </label>
                    </div>
                </section>
                
                <section style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Logging</h3>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                            <input type="checkbox" 
                                   checked="@AppState.Preferences.LoggingEnabled" 
                                   @onchange="ToggleLogging" />
                            <span>Enable detailed logging</span>
                        </label>
                        @if (AppState.Preferences.LoggingEnabled)
                        {
                            <div style="padding-left:24px;">
                                <p style="font-size:12px; color:var(--muted); margin:0 0 8px 0;">
                                    Logs are saved to your application data folder. Useful for troubleshooting.
                                </p>
                                <button @onclick="OpenLogFolder" 
                                        style="padding:4px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:12px;">
                                    Open Log Folder
                                </button>
                            </div>
                        }
                    </div>
                </section>
                
                <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
                    <button @onclick="OnClose" style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private async Task SetTheme(ThemeMode mode)
    {
        if (mode == ThemeMode.System)
        {
            // OS follow deferred; ignore selection of System for now
            return;
        }
        // Apply requested theme and persist preferences
        AppState.Preferences.Theme = mode;
        await AppState.SavePreferencesAsync();
        await AppState.ApplyThemeAsync();
        
    }

    private async Task ToggleLogging(ChangeEventArgs e)
    {
        AppState.Preferences.LoggingEnabled = (bool)(e.Value ?? false);
        await AppState.SavePreferencesAsync();
    }

    private void OpenLogFolder()
    {
        var appDataDir = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        var logDir = Path.Combine(appDataDir, "Scrappy", "Logs");
        
        // Open folder in system file explorer
        try
        {
            var psi = new System.Diagnostics.ProcessStartInfo
            {
                FileName = logDir,
                UseShellExecute = true
            };
            System.Diagnostics.Process.Start(psi);
        }
        catch
        {
            // Silently fail if folder can't be opened
        }
    }
}
