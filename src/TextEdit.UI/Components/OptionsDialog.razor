@using TextEdit.Core.Preferences
@using Microsoft.JSInterop
@using TextEdit.UI.App
@using TextEdit.Infrastructure.Ipc
@inject AppState AppState
@inject IpcBridge IpcBridge
@inject IJSRuntime JS
@inject TextEdit.Infrastructure.Updates.AutoUpdateService AutoUpdateService
@inject TextEdit.UI.App.DialogService DialogService
@using System.Runtime.InteropServices
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@using TextEdit.UI.Components.Editor
@using Microsoft.Extensions.Configuration
@inject TextEdit.Infrastructure.SpellChecking.SpellCheckingService SpellCheckingService
@inject TextEdit.Infrastructure.SpellChecking.DictionaryInstaller DictionaryInstaller
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration

@if (IsVisible)
{
    <div class="dialog-overlay" @onclick="OnClose" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div id="options-dialog" class="dialog-content" role="dialog" aria-modal="true" aria-labelledby="options-dialog-title" aria-describedby="options-dialog-desc" tabindex="-1" @ref="_dialogRef" @onclick:stopPropagation="true" @onkeydown="HandleKeyDown" style="min-height:520px; max-height:520px; max-width: 520px; width: 100%; background: var(--bg); color: var(--fg); border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.15), 0 10px 10px -5px rgba(0,0,0,0.1); overflow: hidden; display:flex; flex-direction:column;">
        <div style="background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;">
                <h2 id="options-dialog-title" style="margin: 0; font-size: 14px; font-weight: 600; color: var(--fg);">Options</h2>
                <button @onclick="OnClose"
                        style="border: none; background: transparent; font-size: 20px; color: var(--muted); cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                    ×
                </button>
            </div>
            <div id="options-dialog-desc" style="padding: 24px; overflow-y: auto; flex:1 1 auto; min-height:0;">
                <div class="tab-strip" role="tablist" aria-label="Options Sections" style="gap:6px; margin-bottom:12px;">
                    <button role="tab" aria-selected="@(SelectedTab == OptionsTab.Extensions ? "true" : "false")" aria-controls="panel-extensions" @onclick="() => SelectTab(OptionsTab.Extensions)" class="tab">Recognized File Extensions</button>
                    <button role="tab" aria-selected="@(SelectedTab == OptionsTab.Theme ? "true" : "false")" aria-controls="panel-theme" @onclick="() => SelectTab(OptionsTab.Theme)" class="tab">Theme</button>
                    <button role="tab" aria-selected="@(SelectedTab == OptionsTab.Logging ? "true" : "false")" aria-controls="panel-logging" @onclick="() => SelectTab(OptionsTab.Logging)" class="tab">Logging</button>
                    <button role="tab" aria-selected="@(SelectedTab == OptionsTab.Updates ? "true" : "false")" aria-controls="panel-updates" @onclick="() => SelectTab(OptionsTab.Updates)" class="tab">Updates</button>
                    <button role="tab" aria-selected="@(SelectedTab == OptionsTab.Editor ? "true" : "false")" aria-controls="panel-editor" @onclick="() => SelectTab(OptionsTab.Editor)" class="tab">Editor</button>
                    <button role="tab" aria-selected="@(SelectedTab == OptionsTab.SpellCheck ? "true" : "false")" aria-controls="panel-spellcheck" @onclick="() => SelectTab(OptionsTab.SpellCheck)" class="tab">Spell Check</button>
                </div>

                @if (SelectedTab == OptionsTab.Extensions)
                {
                <section id="panel-extensions" role="tabpanel" aria-labelledby="panel-extensions-label" style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Recognized File Extensions</h3>
                    <p style="font-size:12px; color:var(--muted); margin:0 0 8px 0;">Files with these extensions are treated as text and can be opened. .txt and .md cannot be removed.</p>
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                        <input aria-label="New file extension" placeholder=".conf" value="@_newExtension" @oninput="e => _newExtension = e.Value?.ToString() ?? string.Empty" style="flex:1; padding:6px 8px; border:1px solid var(--border); background:var(--surface); color:var(--fg); border-radius:6px;" />
                        <button aria-label="Add extension" @onclick="AddExtension" style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Add</button>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(_extError))
                    {
                        <div role="alert" aria-live="assertive" style="color: var(--danger, #d14343); font-size:12px; margin-bottom:8px;">@_extError</div>
                    }
                    <div style="max-height: 104px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 8px; background: var(--surface);">
                        <ul style="list-style:none; padding:0; margin:0; display:flex; flex-wrap:wrap; gap:8px;">
                            @foreach (var ext in AppState.Preferences.FileExtensions.OrderBy(e => e))
                            {
                                var isRequired = string.Equals(ext, ".txt", StringComparison.OrdinalIgnoreCase) || string.Equals(ext, ".md", StringComparison.OrdinalIgnoreCase);
                                <li style="display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); background:var(--bg); color:var(--fg); border-radius:999px;">
                                    <span>@ext</span>
                                    <button @onclick="() => RemoveExtension(ext)"
                                            disabled="@isRequired"
                                            title="@(isRequired ? "Required extension" : "Remove")"
                                            aria-label="@(isRequired ? $"Cannot remove required extension {ext}" : $"Remove extension {ext}")"
                                            style="padding:2px 8px; background: transparent; color: var(--muted); border:1px solid var(--border); border-radius:999px; cursor:@(isRequired ? "not-allowed" : "pointer");">
                                        ×
                                    </button>
                                </li>
                            }
                        </ul>
                    </div>
                </section>
                }
                
                @if (SelectedTab == OptionsTab.Theme)
                {
                    <section id="panel-theme" role="tabpanel" aria-labelledby="panel-theme-label" style="margin-bottom: 20px;">
                        <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Theme</h3>
                        <div style="display:flex; gap:16px; align-items:center;">
                            <label style="display:flex; gap:6px; align-items:center; cursor:pointer; color: var(--fg);" @onclick="() => SetTheme(ThemeMode.Light)">
                                <input type="radio" name="theme" value="Light" checked="@(AppState.Preferences.Theme == ThemeMode.Light)" />
                                <span>Light</span>
                            </label>
                            <label style="display:flex; gap:6px; align-items:center; cursor:pointer; color: var(--fg);" @onclick="() => SetTheme(ThemeMode.Dark)">
                                <input type="radio" name="theme" value="Dark" checked="@(AppState.Preferences.Theme == ThemeMode.Dark)" />
                                <span>Dark</span>
                            </label>
                            <label style="display:flex; gap:6px; align-items:center; color: var(--muted); cursor:not-allowed;">
                                <input type="radio" name="theme" value="System" disabled checked="@(AppState.Preferences.Theme == ThemeMode.System)" />
                                <span>System (disabled)</span>
                            </label>
                        </div>
                    </section>
                }
                @if (SelectedTab == OptionsTab.Editor)
                {
                    <section id="panel-editor" role="tabpanel" aria-labelledby="panel-editor-label" style="margin-bottom: 20px;">
                        <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Editor Options</h3>
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            <!-- Word Wrap -->
                            <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                                <input type="checkbox" checked="@AppState.EditorState.WordWrap" @onchange="ToggleWordWrap" />
                                <span>Enable word wrap (Alt+Z)</span>
                            </label>

                            <!-- Line Numbers -->
                            <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                                <input type="checkbox" checked="@AppState.Preferences.ShowLineNumbers" @onchange="ToggleLineNumbers" />
                                <span>Show line numbers</span>
                            </label>

                            <!-- Minimap -->
                            <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                                <input type="checkbox" checked="@AppState.Preferences.ShowMinimap" @onchange="ToggleMinimap" />
                                <span>Show minimap</span>
                            </label>

                            <p style="font-size:12px; color:var(--muted); margin:8px 0 0 0;">Font size and family can be changed using the toolbar dropdowns.</p>
                        </div>
                    </section>
                }
                @if (SelectedTab == OptionsTab.SpellCheck)
                {
                    <section id="panel-spellcheck" role="tabpanel" aria-labelledby="panel-spellcheck-label" style="margin-bottom: 20px;">
                        <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Spell Check</h3>
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                                <input type="checkbox" checked="@AppState.Preferences.SpellCheck.IsEnabled" @onchange="ToggleSpellCheckEnabled" />
                                <span>Enable spell checking</span>
                            </label>
                            <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                                <input type="checkbox" checked="@AppState.Preferences.SpellCheck.CheckCodeBlocks" @onchange="ToggleCheckCodeBlocks" />
                                <span>Check code blocks and fenced markup</span>
                            </label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label style="font-size:12px; color:var(--muted);">Debounce</label>
                                <input type="number" min="0" value="@AppState.Preferences.SpellCheck.DebounceIntervalMs" @onchange="UpdateDebounceInterval" style="width:120px; padding:4px 8px; border:1px solid var(--border); background:var(--surface); color:var(--fg); border-radius:4px;" />
                                <label style="font-size:12px; color:var(--muted);">ms</label>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <label style="font-size:12px; color:var(--muted);">Max suggestions</label>
                                <input type="number" min="1" max="20" value="@AppState.Preferences.SpellCheck.MaxSuggestions" @onchange="UpdateMaxSuggestions" style="width:80px; padding:4px 8px; border:1px solid var(--border); background:var(--surface); color:var(--fg); border-radius:4px;" />
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <button @onclick="InstallDefaultDictionaries" disabled="@_downloadInProgress" aria-label="Download default dictionaries" style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:12px;">@(_downloadInProgress ? "Downloading..." : "Download default dictionaries")</button>

                                <label for="dictionary-files" aria-label="Choose dictionary files (.dic/.aff)" class="button-like" style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:4px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; font-size:12px;">Select dictionary files...</label>
                                <button @onclick="OpenDictionaryFolder" aria-label="Open dictionary folder" style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:12px;">Open dictionary folder</button>
                            </div>
                            <!-- Hidden file inputs for in-dialog selection -->
                            <InputFile id="dictionary-files" style="display:none" Multiple OnChange="OnFilesSelected" accept=".dic,.aff" />
                            <div style="font-size:12px; margin-top:6px; color:var(--muted);">
                                @if (!string.IsNullOrWhiteSpace(_selectedDicFileName)) { <div>.dic: <strong>@_selectedDicFileName</strong></div> }
                                @if (!string.IsNullOrWhiteSpace(_selectedAffFileName)) { <div>.aff: <strong>@_selectedAffFileName</strong></div> }
                            </div>
                            <div style="padding:8px; font-size:12px; color:var(--muted); background:var(--surface); border:1px solid var(--border); border-radius:6px;">
                                <div style="margin-bottom:4px;">Status: <strong style="color:var(--fg);">@(SpellCheckingService?.IsInitialized == true ? "Ready" : "Disabled (no dictionary loaded)")</strong></div>
                                <div>Custom dictionary path: <strong>@TextEdit.Infrastructure.SpellChecking.DictionaryService.GetCustomDictionaryPath()</strong></div>
                                @if (!string.IsNullOrWhiteSpace(_downloadStatus))
                                {
                                    <div style="margin-top:6px;color:var(--fg);">@_downloadStatus</div>
                                }
                            </div>
                        </div>
                    </section>
                }
                
                
                @if (SelectedTab == OptionsTab.Logging)
                {
                    <section style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Logging</h3>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                            <input type="checkbox" 
                                   checked="@AppState.Preferences.LoggingEnabled" 
                                   @onchange="ToggleLogging" />
                            <span>Enable detailed logging</span>
                        </label>
                        @if (AppState.Preferences.LoggingEnabled)
                        {
                            <div style="padding-left:24px;">
                                <p style="font-size:12px; color:var(--muted); margin:0 0 8px 0;">
                                    Logs are saved to your application data folder. Useful for troubleshooting.
                                </p>
                                <button @onclick="OpenLogFolder" 
                                        aria-label="Open log folder"
                                        style="padding:4px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:12px;">
                                    Open Log Folder
                                </button>
                            </div>
                        }
                    </div>
                    </section>
                }
                
                @if (SelectedTab == OptionsTab.Updates)
                {
                    <section style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Automatic Updates</h3>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                            <input type="checkbox" 
                                   checked="@AppState.Preferences.Updates.CheckOnStartup" 
                                   @onchange="ToggleCheckOnStartup" />
                            <span>Check for updates on startup</span>
                        </label>
                        <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                            <input type="checkbox" 
                                   checked="@AppState.Preferences.Updates.AutoDownload" 
                                   @onchange="ToggleAutoDownload" />
                            <span>Download updates automatically</span>
                        </label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label style="font-size:12px; color:var(--muted);">Check every</label>
                            <input type="number" 
                                   min="1" 
                                   max="168"
                                   value="@AppState.Preferences.Updates.CheckIntervalHours" 
                                   @onchange="UpdateCheckInterval"
                                   style="width:60px; padding:4px 8px; border:1px solid var(--border); background:var(--surface); color:var(--fg); border-radius:4px;" />
                            <label style="font-size:12px; color:var(--muted);">hours</label>
                        </div>
                        <div style="padding:8px; background:var(--surface); border:1px solid var(--border); border-radius:6px; font-size:12px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span style="color:var(--muted);">Current version:</span>
                                <span style="color:var(--fg); font-weight:500;">@_currentVersion</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span style="color:var(--muted);">Last check:</span>
                                <span style="color:var(--fg);">@FormatLastCheckTime()</span>
                            </div>
                            <div style="display:flex; justify-content:space-between;">
                                <span style="color:var(--muted);">Status:</span>
                                <span style="color:var(--fg);">@_updateStatus</span>
                            </div>
                        </div>
                        <button @onclick="CheckForUpdatesNow" 
                                disabled="@_isCheckingForUpdates"
                                aria-label="Check for updates now"
                                style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:4px; cursor:@(_isCheckingForUpdates ? "not-allowed" : "pointer"); font-size:12px;">
                            @(_isCheckingForUpdates ? "Checking..." : "Check for Updates Now")
                        </button>
                        @if (!string.IsNullOrWhiteSpace(AutoUpdateService.AvailableUpdate?.DownloadUrl) && !RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
                        {
                            <div class="mt-2" style="font-size:12px; color:var(--muted)">
                                <a class="text-blue-600 underline" href="#" @onclick="() => IpcBridge.OpenExternalAsync(AutoUpdateService.AvailableUpdate.DownloadUrl)">Download update</a>
                                @if (AutoUpdateService.AvailableUpdate.FileSizeBytes > 0)
                                {
                                    <span class="text-sm text-gray-500"> (@FormatFileSize(AutoUpdateService.AvailableUpdate.FileSizeBytes))</span>
                                }
                            </div>
                        }
                    </div>
                    </section>
                }
                
            </div>

            <!-- Footer with persistent actions -->
            <div style="padding: 12px 24px; border-top: 1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; background: var(--dialog-surface);">
                <button @onclick="OnClose" style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Close</button>
            </div>
        </div>
    </div>
}

@* AutoUpdateService was already injected at top; duplicate injection removed. *@

@code {
    private ElementReference _dialogRef;
    private DotNetObjectReference<OptionsDialog>? _dotNetRef;
    private bool _trapAttached;
    private OptionsTab SelectedTab { get; set; } = OptionsTab.Extensions;

    private enum OptionsTab
    {
        Extensions,
        Theme,
        Logging,
        Updates,
        Editor
        , SpellCheck
    }
    private string _currentVersion = GetVersion();
    private string _updateStatus = "Idle";
    private bool _isCheckingForUpdates = false;
    
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    protected override void OnInitialized()
    {
        AutoUpdateService.StatusChanged += OnUpdateStatusChanged;
        UpdateStatusDisplay();
    }

    private void SelectTab(OptionsTab t)
    {
        SelectedTab = t;
    }
    
    private static string GetVersion()
    {
        try
        {
            var assembly = System.Reflection.Assembly.GetExecutingAssembly();
            var version = assembly.GetName().Version;
            return version != null ? $"{version.Major}.{version.Minor}.{version.Build}" : "1.2.0";
        }
        catch
        {
            return "1.2.0";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !_trapAttached)
        {
            await Task.Delay(50); // Wait for dialog to render
            await _dialogRef.FocusAsync();
            _dotNetRef ??= DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("textEditFocusTrap.trap", "#options-dialog", _dotNetRef, "CloseDialog");
            _trapAttached = true;
        }
        else if (!IsVisible && _trapAttached)
        {
            await JS.InvokeVoidAsync("textEditFocusTrap.release", "#options-dialog");
            _trapAttached = false;
        }
    }

    [JSInvokable]
    public async Task CloseDialog()
    {
        await OnClose.InvokeAsync();
        await JS.InvokeVoidAsync("editorFocus.focusActiveEditor");
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await OnClose.InvokeAsync();
            await RestoreFocusToEditor();
        }
    }
    
    public void Dispose()
    {
        AutoUpdateService.StatusChanged -= OnUpdateStatusChanged;
        _ = JS.InvokeVoidAsync("textEditFocusTrap.release", "#options-dialog");
        _trapAttached = false;
        _dotNetRef?.Dispose();
    }
    
    private async Task RestoreFocusToEditor()
    {
        try
        {
            await Task.Delay(100); // Allow dialog to close
            await JS.InvokeVoidAsync("editorFocus.focus", "main-editor-textarea");
        }
        catch { /* ignore */ }
    }

    private string _newExtension = string.Empty;
    private string? _extError;

    private async Task SetTheme(ThemeMode mode)
    {
        if (mode == ThemeMode.System)
        {
            // OS follow deferred; ignore selection of System for now
            return;
        }
        // Apply requested theme and persist preferences
        try
        {
            await AppState.SetThemeAsync(mode);
        }
        catch (System.Exception ex)
        {
            DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
        }
        
    }

    private async Task ToggleLogging(ChangeEventArgs e)
    {
        var enable = (bool)(e.Value ?? false);
        try
        {
            await AppState.SetLoggingEnabledAsync(enable);
        }
        catch (System.Exception ex)
        {
            DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
        }
    }

    private async Task AddExtension()
    {
        _extError = null;
        var input = (_newExtension ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(input))
        {
            _extError = "Enter an extension like .conf";
            return;
        }
        if (!input.StartsWith('.')) input = "." + input;
        input = input.ToLowerInvariant();

        // Validate format
        var rx = new System.Text.RegularExpressions.Regex("^\\.[a-zA-Z0-9-]+$");
        if (!rx.IsMatch(input))
        {
            _extError = "Invalid format. Use letters, numbers or hyphen, e.g. .conf";
            return;
        }

        // Duplicate check (case-insensitive)
        if (AppState.Preferences.FileExtensions.Any(e => string.Equals(e, input, StringComparison.OrdinalIgnoreCase)))
        {
            _extError = "Extension already exists";
            return;
        }

        AppState.Preferences.FileExtensions.Add(input);
        AppState.Preferences.NormalizeExtensions();
        await AppState.SavePreferencesAsync();
        _newExtension = string.Empty;
    }

    private async Task RemoveExtension(string ext)
    {
        _extError = null;
        if (string.Equals(ext, ".txt", StringComparison.OrdinalIgnoreCase) || string.Equals(ext, ".md", StringComparison.OrdinalIgnoreCase))
        {
            _extError = $"Cannot remove required extension: {ext}";
            return;
        }
        AppState.Preferences.FileExtensions.RemoveAll(e => string.Equals(e, ext, StringComparison.OrdinalIgnoreCase));
        AppState.Preferences.NormalizeExtensions();
        await AppState.SavePreferencesAsync();
    }

    // Spell check-specific options and actions
    private async Task ToggleSpellCheckEnabled(ChangeEventArgs e)
    {
        var enabled = (bool)(e.Value ?? false);
        AppState.Preferences.SpellCheck.IsEnabled = enabled;
        try
        {
            await AppState.SavePreferencesAsync();
            // Apply to runtime spell checker
            try { SpellCheckingService?.UpdatePreferences(AppState.Preferences.SpellCheck); } catch { }
            // If disabling, clear decorations in editors
            if (!enabled)
            {
                try { await JS.InvokeVoidAsync("textEditMonaco.clearSpellCheckDecorations", "monaco-editor"); } catch { }
            }
        }
        catch (System.Exception ex)
        {
            // revert and notify user
            AppState.Preferences.SpellCheck.IsEnabled = !enabled;
            DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
        }
    }

    private async Task ToggleCheckCodeBlocks(ChangeEventArgs e)
    {
        var enabled = (bool)(e.Value ?? false);
        AppState.Preferences.SpellCheck.CheckCodeBlocks = enabled;
        try
        {
            await AppState.SavePreferencesAsync();
            try { SpellCheckingService?.UpdatePreferences(AppState.Preferences.SpellCheck); } catch { }
        }
        catch (System.Exception ex)
        {
            AppState.Preferences.SpellCheck.CheckCodeBlocks = !enabled;
            DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
        }
    }

    private async Task UpdateDebounceInterval(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var ms) && ms >= 0)
        {
            AppState.Preferences.SpellCheck.DebounceIntervalMs = ms;
            try
            {
                await AppState.SavePreferencesAsync();
                SpellCheckingService?.UpdatePreferences(AppState.Preferences.SpellCheck);
            }
            catch (System.Exception ex)
            {
                DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
            }
        }
    }

    private async Task UpdateMaxSuggestions(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var n) && n >= 1 && n <= 20)
        {
            AppState.Preferences.SpellCheck.MaxSuggestions = n;
            try
            {
                await AppState.SavePreferencesAsync();
                SpellCheckingService?.UpdatePreferences(AppState.Preferences.SpellCheck);
            }
            catch (System.Exception ex)
            {
                DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
            }
        }
    }

    private bool _downloadInProgress = false;
    private string _downloadStatus = string.Empty;
    // _downloadConfirmPending removed: we use immediate download with inline status
    private string? _selectedDicFileName;
    private string? _selectedAffFileName;

    private async Task InstallDefaultDictionaries()
    {
    // reset confirm (no longer used)
        var dicUrl = Configuration["SpellCheck:DefaultDicUrl"];
        var affUrl = Configuration["SpellCheck:DefaultAffUrl"];
        if (string.IsNullOrWhiteSpace(dicUrl) || string.IsNullOrWhiteSpace(affUrl))
        {
            _downloadStatus = "Default dictionary URLs are not configured.";
            return;
        }

        _downloadInProgress = true;
        _downloadStatus = "Downloading...";
        StateHasChanged();
    System.Diagnostics.Debug.WriteLine("[OptionsDialog] Starting dictionary download");

    var success = await DictionaryInstaller.DownloadAndInstallDefaultDictionaryAsync(dicUrl!, affUrl!);
        _downloadInProgress = false;

        if (success)
        {
            _downloadStatus = "Download complete. Dictionaries installed.";
            System.Diagnostics.Debug.WriteLine("[OptionsDialog] Download complete: attempting to load new dictionaries");
            // Attempt to reinitialize runtime spell checker (best-effort)
            try
            {
                var dicPath = Path.Combine(TextEdit.Infrastructure.SpellChecking.DictionaryService.GetCustomDictionaryPath(), TextEdit.Infrastructure.SpellChecking.DictionaryService.EnglishDicFileName);
                var affPath = Path.Combine(TextEdit.Infrastructure.SpellChecking.DictionaryService.GetCustomDictionaryPath(), TextEdit.Infrastructure.SpellChecking.DictionaryService.EnglishAffFileName);
                var checker = TextEdit.Infrastructure.SpellChecking.DictionaryService.LoadFromFiles(dicPath, affPath);
                if (checker != null)
                {
                    SpellCheckingService?.ReplaceSpellChecker(checker);
                    SpellCheckingService?.UpdatePreferences(AppState.Preferences.SpellCheck);
                }
            }
            catch (Exception ex)
            {
                _downloadStatus = $"Downloaded but failed to load dictionaries: {ex.Message}";
                System.Diagnostics.Debug.WriteLine($"[OptionsDialog] Failed to load dictionaries after download: {ex.Message}");
            }
        }
        else
        {
            _downloadStatus = "Download failed. Check network or try again.";
            System.Diagnostics.Debug.WriteLine("[OptionsDialog] Download failed");
        }
        StateHasChanged();
    }

    // Removed confirm helpers; downloads now start on single click with inline status

    // TriggerDicSelector removed: use label[for] to open file picker without JS interop.

    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles();
        // find dic and aff
        IBrowserFile? dic = null;
        IBrowserFile? aff = null;
        foreach (var f in files)
        {
            var ext = Path.GetExtension(f.Name)?.ToLowerInvariant();
            if (ext == ".dic") dic = f;
            if (ext == ".aff") aff = f;
        }
        if (dic == null || aff == null)
        {
            _downloadStatus = "Select both .dic and .aff files.";
            StateHasChanged();
            return;
        }

        try
        {
            var customPath = TextEdit.Infrastructure.SpellChecking.DictionaryService.GetCustomDictionaryPath();
            TextEdit.Infrastructure.SpellChecking.DictionaryService.EnsureCustomDictionaryDirectory();
            var destDic = Path.Combine(customPath, TextEdit.Infrastructure.SpellChecking.DictionaryService.EnglishDicFileName);
            var destAff = Path.Combine(customPath, TextEdit.Infrastructure.SpellChecking.DictionaryService.EnglishAffFileName);

            // Save dic
            using (var fs = File.Create(destDic))
            using (var rs = dic.OpenReadStream(50_000_000))
            {
                await rs.CopyToAsync(fs);
            }
            // Save aff
            using (var fs2 = File.Create(destAff))
            using (var rs2 = aff.OpenReadStream(20_000_000))
            {
                await rs2.CopyToAsync(fs2);
            }

            _selectedDicFileName = dic.Name;
            _selectedAffFileName = aff.Name;
            _downloadStatus = "Custom dictionaries installed.";
            StateHasChanged();
            // Attempt to reinitialize runtime spell checker
            try
            {
                var checker = TextEdit.Infrastructure.SpellChecking.DictionaryService.LoadFromFiles(destDic, destAff);
                if (checker != null)
                {
                    SpellCheckingService?.ReplaceSpellChecker(checker);
                }
            }
            catch { }
        }
        catch (Exception ex)
        {
            _downloadStatus = $"Failed to install custom dictionaries: {ex.Message}";
        }
    }

    private Task ChooseCustomDicAndAff() => Task.CompletedTask; // label[for] triggers picker; placeholder kept for compatibility

    private async Task OpenDictionaryFolder()
    {
        var customPath = TextEdit.Infrastructure.SpellChecking.DictionaryService.GetCustomDictionaryPath();
        try
        {
            await IpcBridge.OpenExternalAsync(customPath);
        }
        catch { }
    }

    private void OpenLogFolder()
    {
        var appDataDir = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        var logDir = Path.Combine(appDataDir, "Scrappy", "Logs");
        
        // Open folder in system file explorer
        try
        {
            var psi = new System.Diagnostics.ProcessStartInfo
            {
                FileName = logDir,
                UseShellExecute = true
            };
            System.Diagnostics.Process.Start(psi);
        }
        catch
        {
            // Silently fail if folder can't be opened
        }
    }

    // Auto-update event handlers and methods (US6)
    
    private void OnUpdateStatusChanged(TextEdit.Core.Updates.UpdateStatus status, TextEdit.Core.Updates.UpdateMetadata? metadata)
    {
        InvokeAsync(() =>
        {
            UpdateStatusDisplay();
            StateHasChanged();
        });
    }

    private void UpdateStatusDisplay()
    {
        _updateStatus = AutoUpdateService.CurrentStatus switch
        {
            TextEdit.Core.Updates.UpdateStatus.Idle => "Idle",
            TextEdit.Core.Updates.UpdateStatus.Checking => "Checking...",
            TextEdit.Core.Updates.UpdateStatus.Available => "Update available",
            TextEdit.Core.Updates.UpdateStatus.Downloading => $"Downloading... {AutoUpdateService.DownloadPercent}%",
            TextEdit.Core.Updates.UpdateStatus.Ready => "Ready to install",
            TextEdit.Core.Updates.UpdateStatus.Error => "Error",
            TextEdit.Core.Updates.UpdateStatus.UpToDate => "Up to date",
            _ => "Unknown"
        };
    }

    private async Task ToggleCheckOnStartup(ChangeEventArgs e)
    {
        AppState.Preferences.Updates.CheckOnStartup = (bool)(e.Value ?? false);
        try
        {
            await AppState.SavePreferencesAsync();
        }
        catch (System.Exception ex)
        {
            // Revert and notify user
            AppState.Preferences.Updates.CheckOnStartup = !(bool)(e.Value ?? false);
            DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
        }
    }

    private async Task ToggleAutoDownload(ChangeEventArgs e)
    {
        AppState.Preferences.Updates.AutoDownload = (bool)(e.Value ?? false);
        try
        {
            await AppState.SavePreferencesAsync();
        }
        catch (System.Exception ex)
        {
            AppState.Preferences.Updates.AutoDownload = !(bool)(e.Value ?? false);
            DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
        }
    }

    private async Task UpdateCheckInterval(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var hours) && hours >= 1 && hours <= 168)
        {
            AppState.Preferences.Updates.CheckIntervalHours = hours;
            try
            {
                await AppState.SavePreferencesAsync();
            }
            catch (System.Exception ex)
            {
                DialogService.ShowErrorDialog("Preferences Error", $"Failed to save preferences: {ex.Message}");
            }
        }
    }

    private string FormatLastCheckTime()
    {
        var lastCheck = AppState.Preferences.Updates.LastCheckTime;
        if (!lastCheck.HasValue)
            return "Never";
        
        var elapsed = DateTimeOffset.UtcNow - lastCheck.Value;
        if (elapsed.TotalMinutes < 1)
            return "Just now";
        if (elapsed.TotalHours < 1)
            return $"{(int)elapsed.TotalMinutes} minutes ago";
        if (elapsed.TotalDays < 1)
            return $"{(int)elapsed.TotalHours} hours ago";
        if (elapsed.TotalDays < 7)
            return $"{(int)elapsed.TotalDays} days ago";
        
        return lastCheck.Value.ToLocalTime().ToString("MMM d, yyyy");
    }

    private async Task CheckForUpdatesNow()
    {
        _isCheckingForUpdates = true;
        StateHasChanged();
        
        try
        {
            await AutoUpdateService.CheckForUpdatesAsync(AppState.Preferences.Updates.AutoDownload, initiatedByUser: true);
            AppState.Preferences.Updates.LastCheckTime = DateTimeOffset.UtcNow;
            await AppState.SavePreferencesAsync();
        }
        finally
        {
            _isCheckingForUpdates = false;
            StateHasChanged();
        }
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes <= 0) return "0 B";
        var sizes = new[] { "B", "KB", "MB", "GB", "TB" };
        var order = (int)Math.Floor(Math.Log(bytes, 1024));
        order = Math.Min(order, sizes.Length - 1);
        var adjusted = bytes / Math.Pow(1024, order);
        return $"{adjusted:0.##} {sizes[order]}";
    }

    // Editor settings - Now bound to AppState.Preferences for persistence
    
    private async Task ToggleWordWrap(ChangeEventArgs e)
    {
        // Word wrap is controlled via EditorCommandHub which syncs with AppState and View menu
        try
        {
            await EditorCommandHub.InvokeSafe(EditorCommandHub.ToggleWordWrapRequested);
        }
        catch (System.Exception ex)
        {
            DialogService.ShowErrorDialog("Editor Error", $"Failed to toggle word wrap: {ex.Message}");
        }
    }

    private async Task ToggleLineNumbers(ChangeEventArgs e)
    {
        bool enabled = (bool)(e.Value ?? true);
        AppState.Preferences.ShowLineNumbers = enabled;
        try
        {
            await AppState.SavePreferencesAsync();
            await JS.InvokeVoidAsync("textEditMonaco.setLineNumbers", "monaco-editor", enabled);
        }
        catch (System.Exception ex)
        {
            DialogService.ShowErrorDialog("Editor Error", $"Failed to apply setting: {ex.Message}");
        }
    }

    private async Task ToggleMinimap(ChangeEventArgs e)
    {
        bool enabled = (bool)(e.Value ?? false);
        AppState.Preferences.ShowMinimap = enabled;
        try
        {
            await AppState.SavePreferencesAsync();
            await JS.InvokeVoidAsync("textEditMonaco.setMinimap", "monaco-editor", enabled);
        }
        catch (System.Exception ex)
        {
            DialogService.ShowErrorDialog("Editor Error", $"Failed to apply setting: {ex.Message}");
        }
    }
}
