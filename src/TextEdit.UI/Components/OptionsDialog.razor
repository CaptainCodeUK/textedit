@using TextEdit.Core.Preferences
@using Microsoft.JSInterop
@using TextEdit.UI.App
@using TextEdit.Infrastructure.Ipc
@inject AppState AppState
@inject IpcBridge IpcBridge
@inject IJSRuntime JS

@if (IsVisible)
{
    <div class="dialog-overlay" @onclick="OnClose" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div id="options-dialog" class="dialog-content" role="dialog" aria-modal="true" aria-labelledby="options-dialog-title" aria-describedby="options-dialog-desc" tabindex="-1" @ref="_dialogRef" @onclick:stopPropagation="true" @onkeydown="HandleKeyDown" style="max-width: 520px; width: 100%; background: var(--bg); color: var(--fg); border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.15), 0 10px 10px -5px rgba(0,0,0,0.1); overflow: hidden;">
            <div style="background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;">
                <h2 id="options-dialog-title" style="margin: 0; font-size: 14px; font-weight: 600; color: var(--fg);">Options</h2>
                <button @onclick="OnClose"
                        style="border: none; background: transparent; font-size: 20px; color: var(--muted); cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                    ×
                </button>
            </div>
            <div id="options-dialog-desc" style="padding: 24px;">
                <section style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Recognized File Extensions</h3>
                    <p style="font-size:12px; color:var(--muted); margin:0 0 8px 0;">Files with these extensions are treated as text and can be opened. .txt and .md cannot be removed.</p>
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                        <input placeholder=".conf" value="@_newExtension" @oninput="e => _newExtension = e.Value?.ToString() ?? string.Empty" style="flex:1; padding:6px 8px; border:1px solid var(--border); background:var(--surface); color:var(--fg); border-radius:6px;" />
                        <button @onclick="AddExtension" style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Add</button>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(_extError))
                    {
                        <div style="color: var(--danger, #d14343); font-size:12px; margin-bottom:8px;">@_extError</div>
                    }
                    <div style="max-height: 104px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 8px; background: var(--surface);">
                        <ul style="list-style:none; padding:0; margin:0; display:flex; flex-wrap:wrap; gap:8px;">
                            @foreach (var ext in AppState.Preferences.FileExtensions.OrderBy(e => e))
                            {
                                var isRequired = string.Equals(ext, ".txt", StringComparison.OrdinalIgnoreCase) || string.Equals(ext, ".md", StringComparison.OrdinalIgnoreCase);
                                <li style="display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); background:var(--bg); color:var(--fg); border-radius:999px;">
                                    <span>@ext</span>
                                    <button @onclick="() => RemoveExtension(ext)"
                                            disabled="@isRequired"
                                            title="@(isRequired ? "Required extension" : "Remove")"
                                            style="padding:2px 8px; background: transparent; color: var(--muted); border:1px solid var(--border); border-radius:999px; cursor:@(isRequired ? "not-allowed" : "pointer");">
                                        ×
                                    </button>
                                </li>
                            }
                        </ul>
                    </div>
                </section>
                <section style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Theme</h3>
                    <div style="display:flex; gap:16px; align-items:center;">
                        <label style="display:flex; gap:6px; align-items:center; cursor:pointer; color: var(--fg);" @onclick="() => SetTheme(ThemeMode.Light)">
                            <input type="radio" name="theme" value="Light" checked="@(AppState.Preferences.Theme == ThemeMode.Light)" />
                            <span>Light</span>
                        </label>
                        <label style="display:flex; gap:6px; align-items:center; cursor:pointer; color: var(--fg);" @onclick="() => SetTheme(ThemeMode.Dark)">
                            <input type="radio" name="theme" value="Dark" checked="@(AppState.Preferences.Theme == ThemeMode.Dark)" />
                            <span>Dark</span>
                        </label>
                        <label style="display:flex; gap:6px; align-items:center; color: var(--muted); cursor:not-allowed;">
                            <input type="radio" name="theme" value="System" disabled checked="@(AppState.Preferences.Theme == ThemeMode.System)" />
                            <span>System (disabled)</span>
                        </label>
                    </div>
                </section>
                
                <section style="margin-bottom: 20px;">
                    <h3 style="font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: var(--fg);">Logging</h3>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <label style="display:flex; gap:8px; align-items:center; cursor:pointer; color: var(--fg);">
                            <input type="checkbox" 
                                   checked="@AppState.Preferences.LoggingEnabled" 
                                   @onchange="ToggleLogging" />
                            <span>Enable detailed logging</span>
                        </label>
                        @if (AppState.Preferences.LoggingEnabled)
                        {
                            <div style="padding-left:24px;">
                                <p style="font-size:12px; color:var(--muted); margin:0 0 8px 0;">
                                    Logs are saved to your application data folder. Useful for troubleshooting.
                                </p>
                                <button @onclick="OpenLogFolder" 
                                        style="padding:4px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:12px;">
                                    Open Log Folder
                                </button>
                            </div>
                        }
                    </div>
                </section>
                
                <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px;">
                    <button @onclick="OnClose" style="padding:6px 12px; background: var(--surface); color: var(--fg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private ElementReference _dialogRef;
    private DotNetObjectReference<OptionsDialog>? _dotNetRef;
    private bool _trapAttached;
    
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !_trapAttached)
        {
            await Task.Delay(50); // Wait for dialog to render
            await _dialogRef.FocusAsync();
            _dotNetRef ??= DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("textEditFocusTrap.trap", "#options-dialog", _dotNetRef, "CloseDialog");
            _trapAttached = true;
        }
        else if (!IsVisible && _trapAttached)
        {
            await JS.InvokeVoidAsync("textEditFocusTrap.release", "#options-dialog");
            _trapAttached = false;
        }
    }

    [JSInvokable]
    public async Task CloseDialog()
    {
        await OnClose.InvokeAsync();
        await RestoreFocusToEditor();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await OnClose.InvokeAsync();
            await RestoreFocusToEditor();
        }
    }
    
    public void Dispose()
    {
        _ = JS.InvokeVoidAsync("textEditFocusTrap.release", "#options-dialog");
        _trapAttached = false;
        _dotNetRef?.Dispose();
    }
    
    private async Task RestoreFocusToEditor()
    {
        try
        {
            await Task.Delay(100); // Allow dialog to close
            await JS.InvokeVoidAsync("editorFocus.focus", "main-editor-textarea");
        }
        catch { /* ignore */ }
    }

    private string _newExtension = string.Empty;
    private string? _extError;

    private async Task SetTheme(ThemeMode mode)
    {
        if (mode == ThemeMode.System)
        {
            // OS follow deferred; ignore selection of System for now
            return;
        }
        // Apply requested theme and persist preferences
        AppState.Preferences.Theme = mode;
        await AppState.SavePreferencesAsync();
        await AppState.ApplyThemeAsync();
        
    }

    private async Task ToggleLogging(ChangeEventArgs e)
    {
        AppState.Preferences.LoggingEnabled = (bool)(e.Value ?? false);
        await AppState.SavePreferencesAsync();
    }

    private async Task AddExtension()
    {
        _extError = null;
        var input = (_newExtension ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(input))
        {
            _extError = "Enter an extension like .conf";
            return;
        }
        if (!input.StartsWith('.')) input = "." + input;
        input = input.ToLowerInvariant();

        // Validate format
        var rx = new System.Text.RegularExpressions.Regex("^\\.[a-zA-Z0-9-]+$");
        if (!rx.IsMatch(input))
        {
            _extError = "Invalid format. Use letters, numbers or hyphen, e.g. .conf";
            return;
        }

        // Duplicate check (case-insensitive)
        if (AppState.Preferences.FileExtensions.Any(e => string.Equals(e, input, StringComparison.OrdinalIgnoreCase)))
        {
            _extError = "Extension already exists";
            return;
        }

        AppState.Preferences.FileExtensions.Add(input);
        AppState.Preferences.NormalizeExtensions();
        await AppState.SavePreferencesAsync();
        _newExtension = string.Empty;
    }

    private async Task RemoveExtension(string ext)
    {
        _extError = null;
        if (string.Equals(ext, ".txt", StringComparison.OrdinalIgnoreCase) || string.Equals(ext, ".md", StringComparison.OrdinalIgnoreCase))
        {
            _extError = $"Cannot remove required extension: {ext}";
            return;
        }
        AppState.Preferences.FileExtensions.RemoveAll(e => string.Equals(e, ext, StringComparison.OrdinalIgnoreCase));
        AppState.Preferences.NormalizeExtensions();
        await AppState.SavePreferencesAsync();
    }

    private void OpenLogFolder()
    {
        var appDataDir = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        var logDir = Path.Combine(appDataDir, "Scrappy", "Logs");
        
        // Open folder in system file explorer
        try
        {
            var psi = new System.Diagnostics.ProcessStartInfo
            {
                FileName = logDir,
                UseShellExecute = true
            };
            System.Diagnostics.Process.Start(psi);
        }
        catch
        {
            // Silently fail if folder can't be opened
        }
    }
}
