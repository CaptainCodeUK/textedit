@using TextEdit.UI.App
@using TextEdit.UI.Components.Editor
@using TextEdit.Core.Documents
@using Microsoft.JSInterop
@inject AppState State
@inject IJSRuntime JSRuntime
@implements System.IDisposable

<nav class="tab-strip" 
     role="tablist" 
     aria-label="Open documents"
     style="display:flex;gap:6px;align-items:flex-end;overflow-x:auto;" 
     @onclick="OnTabStripClick">
    @foreach (var t in State.Tabs)
    {
        var currentTab = t;
        var doc = State.GetDocument(currentTab.DocumentId);
        if (doc != null)
        {
            // Use StateVersion to force complete re-render when anything changes
            var renderKey = $"{currentTab.Id}-{State.StateVersion}";
            <button @key="@renderKey" 
                    class="tab"
                    role="tab"
                    id="tab-@currentTab.Id"
                    aria-selected="@currentTab.IsActive.ToString().ToLower()"
                    aria-controls="editor-panel"
                    style="border:none;border-bottom:2px solid @(currentTab.IsActive ? "#2563eb" : "transparent");padding:6px 10px;background:transparent;cursor:pointer;"
                    @onclick="(() => OnActivate(currentTab.Id))"
                    @onclick:stopPropagation="true"
                    @onmouseup="(e => OnMouseUp(e, currentTab.Id))"
                    @onmouseup:stopPropagation="true"
                    title="@doc.Name">
                <span>@doc.Name@(doc.IsDirty ? " ●" : "")@(doc.HasExternalModification ? " ↻" : "")</span>
                <span style="margin-left:8px;color:#9ca3af;" 
                      aria-label="Close @doc.Name"
                      role="button"
                      tabindex="0"
                      @onclick="(async () => await OnClose(currentTab.Id))" 
                      @onclick:stopPropagation="true">✕</span>
            </button>
        }
    }
    <button class="tab-add" 
            style="margin-left:8px;" 
            aria-label="New document"
            @onclick="NewTab" 
            @onclick:stopPropagation="true">+</button>
</nav>

@code {
    protected override void OnInitialized()
    {
        // Don't create tabs here; App.razor performs session restore and will
        // create a new document only when no session exists.
        State.Changed += OnStateChanged;
    }

    private void OnStateChanged()
    {
        // Force immediate re-render on the UI thread
        InvokeAsync(async () => 
        {
            await Task.Yield();
            StateHasChanged();
        });
    }
    
    private async Task NewTab()
    {
        State.CreateNew();
        await InvokeAsync(StateHasChanged);
        await FocusEditorAsync();
    }

    private async Task OnActivate(Guid id)
    {
        State.ActivateTab(id);
        await FocusEditorAsync();
    }

    private async Task OnClose(Guid id)
    {
        // Activate the tab and route close via EditorCommandHub so the editor can flush
        State.ActivateTab(id);
        await EditorCommandHub.InvokeSafe(EditorCommandHub.CloseTabRequested);
    }

    private async Task OnMouseUp(MouseEventArgs e, Guid id)
    {
        // Middle mouse button (button 1) closes the tab
        if (e.Button == 1)
        {
            State.ActivateTab(id);
            await EditorCommandHub.InvokeSafe(EditorCommandHub.CloseTabRequested);
        }
    }

    private async Task OnTabStripClick(MouseEventArgs e)
    {
        // If clicking on empty area of tab strip (not on a button), restore focus
        await FocusEditorAsync();
    }

    private async Task FocusEditorAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("editorFocus.focusDelayed", "main-editor-textarea", 50);
        }
        catch
        {
            // Ignore focus errors
        }
    }

    public void Dispose()
    {
        State.Changed -= OnStateChanged;
    }
}