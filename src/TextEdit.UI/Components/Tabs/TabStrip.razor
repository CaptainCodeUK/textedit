@using TextEdit.UI.App
@using TextEdit.UI.Components.Editor
@using TextEdit.Core.Documents
@inject AppState State
@implements System.IDisposable

<div class="tab-strip" style="display:flex;gap:6px;align-items:flex-end;overflow-x:auto;">
    @foreach (var t in State.Tabs)
    {
        var doc = State.GetDocument(t.DocumentId);
        var title = doc?.Name ?? "Untitled";
        var dirty = doc?.IsDirty == true ? " *" : string.Empty;
        <button class="tab"
                style="border:none;border-bottom:2px solid @(t.IsActive ? "#2563eb" : "transparent");padding:6px 10px;background:transparent;cursor:pointer;"
                @onclick="(() => OnActivate(t.Id))"
                @onmouseup="(e => OnMouseUp(e, t.Id))"
                title="@title">
            <span>@title@dirty</span>
            <span style="margin-left:8px;color:#9ca3af;" @onclick="(async () => await OnClose(t.Id))" @onclick:stopPropagation="true">âœ•</span>
        </button>
    }
    <button class="tab-add" style="margin-left:8px;" @onclick="NewTab">+</button>
</div>

@code {
    protected override void OnInitialized()
    {
        // Don't create tabs here; App.razor performs session restore and will
        // create a new document only when no session exists.
        State.Changed += OnStateChanged;
    }

    private void OnStateChanged() => InvokeAsync(StateHasChanged);
    private async Task NewTab()
    {
        State.CreateNew();
        await InvokeAsync(StateHasChanged);
    }

    private void OnActivate(Guid id)
    {
        State.ActivateTab(id);
    }

    private async Task OnClose(Guid id)
    {
        // Activate the tab and route close via EditorCommandHub so the editor can flush
        State.ActivateTab(id);
        await EditorCommandHub.InvokeSafe(EditorCommandHub.CloseTabRequested);
    }

    private async Task OnMouseUp(MouseEventArgs e, Guid id)
    {
        // Middle mouse button (button 1) closes the tab
        if (e.Button == 1)
        {
            State.ActivateTab(id);
            await EditorCommandHub.InvokeSafe(EditorCommandHub.CloseTabRequested);
        }
    }

    public void Dispose()
    {
        State.Changed -= OnStateChanged;
    }
}