@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using TextEdit.Core.Updates
@* JSRuntime and IpcBridge moved to code-behind via [Inject] in UpdateNotificationDialog.razor.cs *@
@using System.Runtime.InteropServices

@* Update notification dialog. Keep markup separate from parameters to avoid Razor parser issues. *@
@if (IsVisible && UpdateMetadata != null)
{
    var md = UpdateMetadata!;

    <div id="update-dialog" @ref="_overlayRef" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="position:fixed !important; inset:0 !important; z-index:2147483647 !important; height:100vh !important; width:100% !important; top:0 !important; left:0 !important;"
         @onclick="HandleBackdropClick" @onkeydown="HandleKeyDown">
        <div id="update-dialog-content" role="dialog" aria-modal="true" aria-labelledby="update-dialog-title" aria-describedby="update-dialog-message" tabindex="-1" @ref="dialogElement" @onclick:stopPropagation="true"
             style="max-width:480px; width:100%; background:var(--bg); border-radius:8px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; max-height:600px; margin:0 16px;">

            <!-- Header -->
            <div style="background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 16px; display:flex; align-items:center; justify-content:space-between;">
                <h2 id="update-dialog-title" style="margin:0; font-size:14px; font-weight:600; color:var(--fg);">@(md.IsCritical ? "Critical Update Available" : "Update Available")</h2>
                <button @onclick="HandleRemindLater" aria-label="Close" style="border:none; background:transparent; font-size:20px; color:var(--muted); cursor:pointer; padding:0; width:24px; height:24px; display:flex; align-items:center; justify-content:center; border-radius:4px; transition:background-color .2s;" onmouseover="this.style.backgroundColor='var(--border)'" onmouseout="this.style.backgroundColor='transparent'">Ã—</button>
            </div>

            <!-- Body (scrollable) -->
            <div class="dialog-body" style="flex:1 1 auto; overflow:auto; padding:32px 24px 24px 24px; box-sizing:border-box;">
                <div style="display:flex; gap:12px; align-items:flex-start;">
                    <div style="flex-shrink:0;">
                        @if (md.IsCritical)
                        {
                            <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="text-red-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        }
                        else
                        {
                            <svg aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="text-blue-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        }
                    </div>
                    <div style="flex:1 1 auto;">
                        <h3 style="margin:0 0 8px 0; font-size:16px; font-weight:600;">@(md.IsCritical ? "Critical Update Available" : "Update Available")</h3>
                        <div id="update-dialog-message" style="font-size:13px; color:var(--muted);">
                            <p style="margin:0 0 8px 0;">Version <strong>@md.Version</strong> is ready to install.</p>

                            @if (!string.IsNullOrWhiteSpace(md.ReleaseNotes))
                            {
                                <div style="margin-top:8px; padding:12px; background:var(--surface); border-radius:6px; font-size:12px; color:var(--fg); max-height:340px; overflow:auto;">
                                    <p style="font-weight:600; margin:0 0 8px 0;">What's New:</p>
                                    <div class="whitespace-pre-wrap">@md.ReleaseNotes</div>
                                </div>
                            }

                            @if (md.IsCritical)
                            {
                                <p style="color:var(--danger); font-weight:600; margin-top:8px;">This is a critical security update. Please install immediately.</p>
                            }

                            @if (!string.IsNullOrWhiteSpace(md.DownloadUrl) && !RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
                            {
                                <p style="margin-top:8px; font-size:13px; color:var(--muted); word-break:break-word;">
                                    <a href="#" style="color:var(--link); text-decoration:underline;" @onclick="OnDownloadClick">Download update</a>
                                    @if (md.FileSizeBytes > 0)
                                    {
                                        <span style="color:var(--muted); font-size:12px;"> (@FormatFileSize(md.FileSizeBytes))</span>
                                    }
                                </p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer (actions) -->
            <div style="border-top:1px solid var(--border); padding:12px 24px; display:flex; justify-content:flex-end; gap:8px;">
                @if (!md.IsCritical)
                {
                    <button @ref="remindButtonElement" type="button" style="padding:6px 12px; background:var(--surface); color:var(--fg); border:1px solid var(--border); border-radius:6px; cursor:pointer;" @onclick="HandleRemindLater">Remind Me Later</button>
                }
                <button @ref="installButtonElement" type="button" style="padding:6px 12px; background:var(--surface); color:var(--fg); border:1px solid var(--border); border-radius:6px; cursor:pointer;" @onclick="HandleInstall">Restart and Update</button>
            </div>

        </div>
    </div>
}
