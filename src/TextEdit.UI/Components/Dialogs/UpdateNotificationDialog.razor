@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using TextEdit.Core.Updates
@inject IJSRuntime JSRuntime
@inject TextEdit.Infrastructure.Ipc.IpcBridge IpcBridge
@using System.Runtime.InteropServices

@if (IsVisible && UpdateMetadata != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" 
         @onclick="HandleBackdropClick"
         @onkeydown="HandleKeyDown">
        <div class="rounded-lg shadow-xl p-6 max-w-lg w-full mx-4" 
             role="dialog" 
             aria-labelledby="update-dialog-title" 
             aria-describedby="update-dialog-message"
             @onclick:stopPropagation="true"
             @ref="dialogElement">
            <div class="flex items-start mb-4">
                <div class="flex-shrink-0">
                    @if (UpdateMetadata.IsCritical)
                    {
                        <svg class="h-6 w-6 text-red-600" aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    }
                    else
                    {
                        <svg class="h-6 w-6 text-blue-600" aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    }
                </div>
                <div class="ml-3 flex-1">
                    <h3 id="update-dialog-title" class="text-lg font-medium">
                        @if (UpdateMetadata.IsCritical)
                        {
                            <text>Critical Update Available</text>
                        }
                        else
                        {
                            <text>Update Available</text>
                        }
                    </h3>
                    <div id="update-dialog-message" class="mt-2 text-sm space-y-2">
                        <p>Version <strong>@UpdateMetadata.Version</strong> is ready to install.</p>
                        
                        @if (!string.IsNullOrWhiteSpace(UpdateMetadata.ReleaseNotes))
                        {
                            <div class="mt-3 p-3 bg-gray-100 rounded text-xs max-h-32 overflow-y-auto">
                                <p class="font-semibold mb-1">What's New:</p>
                                <p class="whitespace-pre-wrap">@UpdateMetadata.ReleaseNotes</p>
                            </div>
                        }
                        
                        @if (UpdateMetadata.IsCritical)
                        {
                            <p class="text-red-600 font-semibold mt-2">This is a critical security update. Please install immediately.</p>
                        }
                        @if (!string.IsNullOrWhiteSpace(UpdateMetadata.DownloadUrl) && !RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
                        {
                            <p class="mt-2">
                                <a href="#" class="text-blue-600 underline" @onclick="OnDownloadClick">Download update</a>
                                @if (UpdateMetadata.FileSizeBytes > 0)
                                {
                                    <span class="text-sm text-gray-500"> (@FormatFileSize(UpdateMetadata.FileSizeBytes))</span>
                                }
                            </p>
                        }
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                @if (!UpdateMetadata.IsCritical)
                {
                    <button 
                        @ref="remindButtonElement"
                        type="button" 
                        class="px-4 py-2 bg-gray-200 text-gray-900 rounded hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400"
                        @onclick="HandleRemindLater"
                        @onkeydown="HandleButtonKeyDown">
                        Remind Me Later
                    </button>
                }
                <button 
                    @ref="installButtonElement"
                    type="button" 
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    @onclick="HandleInstall"
                    @onkeydown="HandleButtonKeyDown">
                    Restart and Update
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public UpdateMetadata? UpdateMetadata { get; set; }

    [Parameter]
    public EventCallback OnInstall { get; set; }

    [Parameter]
    public EventCallback OnRemindLater { get; set; }

    private ElementReference dialogElement;
    private ElementReference installButtonElement;
    private ElementReference remindButtonElement;
    private bool _isClosing = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !_isClosing)
        {
            // Auto-focus the install button (primary action) when dialog opens
            await Task.Delay(10);
            try
            {
                await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('[role=\"dialog\"] button:last-child').focus()");
            }
            catch { /* Ignore focus errors */ }
        }
    }

    private async Task HandleInstall()
    {
        if (_isClosing) return;
        _isClosing = true;
        await OnInstall.InvokeAsync();
    }

    private async Task OnDownloadClick(MouseEventArgs e)
    {
        if (string.IsNullOrWhiteSpace(UpdateMetadata?.DownloadUrl)) return;
        try
        {
            await IpcBridge.OpenExternalAsync(UpdateMetadata.DownloadUrl);
        }
        catch { /* ignore failures */ }
    }

    private async Task HandleRemindLater()
    {
        if (_isClosing) return;
        _isClosing = true;
        await OnRemindLater.InvokeAsync();
    }

    private async Task HandleBackdropClick()
    {
        // For critical updates, don't allow backdrop close
        if (UpdateMetadata?.IsCritical == true) return;
        await HandleRemindLater();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            // For critical updates, don't allow escape
            if (UpdateMetadata?.IsCritical == true) return;
            await HandleRemindLater();
        }
    }

    private Task HandleButtonKeyDown(KeyboardEventArgs e)
    {
        // Tab navigation is handled by browser by default
        // No custom logic needed
        return Task.CompletedTask;
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes <= 0) return "0 B";
        var sizes = new[] { "B", "KB", "MB", "GB", "TB" };
        var order = (int)Math.Floor(Math.Log(bytes, 1024));
        order = Math.Min(order, sizes.Length - 1);
        var adjusted = bytes / Math.Pow(1024, order);
        return $"{adjusted:0.##} {sizes[order]}";
    }
}
