@using System.Reflection
@using Microsoft.JSInterop
@using TextEdit.Infrastructure.Ipc
@inject IpcBridge IpcBridge
@inject IJSRuntime JS

<!-- About Dialog Overlay -->
@if (IsVisible)
{
    <div class="dialog-overlay" @onclick="OnClose" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <div id="about-dialog" class="dialog-content" role="dialog" aria-modal="true" aria-labelledby="about-dialog-title" aria-describedby="about-dialog-desc" tabindex="-1" @ref="_dialogRef" @onclick:stopPropagation="true" @onkeydown="HandleKeyDown" style="max-width: 480px; width: 100%; background: var(--bg); border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden;">
            <!-- Title Bar -->
            <div style="background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;">
                <h2 id="about-dialog-title" style="margin: 0; font-size: 14px; font-weight: 600; color: var(--fg);">About @ApplicationName</h2>
                <button @onclick="OnClose" 
                        style="border: none; background: transparent; font-size: 20px; color: var(--muted); cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background-color 0.2s;"
                        onmouseover="this.style.backgroundColor='var(--border)'" 
                        onmouseout="this.style.backgroundColor='transparent'"
                        aria-label="Close">
                    √ó
                </button>
            </div>
            
            <!-- Dialog Body -->
            <div id="about-dialog-desc" style="padding: 32px 24px; text-align: center; background: var(--bg);">
                <!-- App Icon Placeholder -->
                <div style="margin-bottom: 20px;">
                    <div style="width: 72px; height: 72px; background: linear-gradient(135deg, #3B82F6 0%, #2563eb 100%); border-radius: 16px; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);">
                        üê∂
                    </div>
                </div>
                
                <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600; color: var(--fg);">@ApplicationName</h3>
                <p style="color: var(--muted); margin: 0 0 20px 0; font-size: 14px;">Version @Version</p>
                
                <p style="margin: 0 0 24px 0; line-height: 1.6; color: var(--muted); font-size: 14px;">
                    @Description
                </p>
                
                <!-- Technologies -->
                <div style="margin-bottom: 24px;">
                    <h4 style="font-size: 12px; font-weight: 600; color: var(--muted); margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 0.05em;">Built With</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                        @foreach (var tech in Technologies)
                        {
                            <span style="background: var(--surface); padding: 6px 12px; border-radius: 6px; font-size: 12px; color: var(--fg); font-weight: 500;">
                                @tech
                            </span>
                        }
                    </div>
                </div>
                
                <!-- Copyright and License -->
                <div style="padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="font-size: 12px; color: var(--muted); margin: 0 0 12px 0;">
                        @Copyright
                    </p>
                    @if (!string.IsNullOrWhiteSpace(ProjectUrl))
                    {
                        <p style="margin: 0;">
                            <button type="button" @onclick="OpenGitHubInBrowser"
                               style="color: var(--link); background: none; border: none; text-decoration: none; cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 4px; padding: 0; font-family: inherit;"
                               onmouseover="this.style.color='var(--link-hover)'" 
                               onmouseout="this.style.color='var(--link)'">
                                <span>View on GitHub</span>
                                <span style="font-size: 16px;">‚Üí</span>
                            </button>
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private ElementReference _dialogRef;
    private DotNetObjectReference<AboutDialog>? _dotNetRef;
    private bool _trapAttached;
    
    [Parameter]
    public bool IsVisible { get; set; }
    
    [Parameter]
    public EventCallback OnClose { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !_trapAttached)
        {
            await Task.Delay(50); // Wait for dialog to render
            await _dialogRef.FocusAsync();

            _dotNetRef ??= DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("textEditFocusTrap.trap", "#about-dialog", _dotNetRef, "CloseDialog");
            _trapAttached = true;
        }
        else if (!IsVisible && _trapAttached)
        {
            await JS.InvokeVoidAsync("textEditFocusTrap.release", "#about-dialog");
            _trapAttached = false;
        }
    }

    [JSInvokable]
    public async Task CloseDialog()
    {
        await OnClose.InvokeAsync();
        // Restore focus to editor after closing
        await RestoreFocusToEditor();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await OnClose.InvokeAsync();
            await RestoreFocusToEditor();
        }
    }
    
    private async Task RestoreFocusToEditor()
    {
        try
        {
            await Task.Delay(100); // Allow dialog to close
            await JS.InvokeVoidAsync("editorFocus.focus", "main-editor-textarea");
        }
        catch { /* ignore */ }
    }
    
    public void Dispose()
    {
        _ = JS.InvokeVoidAsync("textEditFocusTrap.release", "#about-dialog");
        _trapAttached = false;
        _dotNetRef?.Dispose();
    }
    
    // Application metadata (T052, T053)
    private string ApplicationName => "Scrappy Text Editor";
    private string Version => GetVersion();
    private string Description => "A friendly, lightweight text editor for everyday writing and markdown";
    private List<string> Technologies => new()
    {
        "Blazor Server",
        "Electron.NET 23.6.2",
        ".NET 8",
        "Markdig"
    };
    private string Copyright => "¬© 2025 - MIT License";
    private string ProjectUrl => "https://github.com/CaptainCodeUK/textedit";
    
    private string GetVersion()
    {
        try
        {
            var assembly = Assembly.GetExecutingAssembly();
            var version = assembly.GetName().Version;
            return version != null ? $"{version.Major}.{version.Minor}.{version.Build}" : "1.1.0";
        }
        catch
        {
            return "1.1.0";
        }
    }
    
    private async Task OpenGitHubInBrowser()
    {
        if (string.IsNullOrWhiteSpace(ProjectUrl)) return;
        
        try
        {
            // Use IpcBridge to open in system browser
            await IpcBridge.OpenExternalAsync(ProjectUrl);
        }
        catch
        {
            // ignore errors; user-facing dialogs will surface issues if needed
        }
    }
}
